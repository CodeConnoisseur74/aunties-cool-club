{% extends 'base.html' %}

{% block title %}Chat Room{% endblock %}

{% block content %}
  <div class="flex flex-col h-screen">
    <div class="flex-grow overflow-y-auto p-4" id="messages">
      {% for message in messages %}
        {% include 'chat/_message.html' with message=message %}
      {% endfor %}
    </div>

    <!-- Message Form -->
    <div class="p-4">
      <form hx-post="{% url 'send_message' chat_room.id %}" hx-target="#messages" hx-swap="beforeend" hx-on="htmx:afterRequest: this.reset()" method="post">
        {% csrf_token %}
        <textarea name="text" class="w-full p-2 border rounded" placeholder="Type your message..." required></textarea>
        <select name="message_type" class="mt-2 p-2 border rounded">
          <option value="message">Message</option>
          <option value="post">Post</option>
          <option value="lesson">Lesson</option>
        </select>
        <button type="submit" class="mt-2 p-2 bg-blue-500 text-white rounded">Send</button>
      </form>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
    <script>
        const ws = new WebSocket("ws://127.0.0.1:8000/ws/chat/{{ chat_room.id }}/");
        console.log(ws);

        ws.onopen = () => console.log("WebSocket connection established!");
        ws.onerror = (error) => console.error("WebSocket error:", error);

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            const messagesDiv = document.getElementById("messages");
            const newMessage = document.createElement("p");
            newMessage.innerHTML = `<strong>${data.sender}:</strong> ${data.message}`;
            messagesDiv.appendChild(newMessage);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };

        function handleKeyPress(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById("messageInput");
            ws.send(JSON.stringify({
                message: input.value,
                sender: "{{ request.user.username }}"
            }));
            input.value = "";
        }
    </script>

{% endblock %}
